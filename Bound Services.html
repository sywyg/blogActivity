<!DOCTYPE html><html><head><meta charset="utf-8"><style>body {
  width: 45em;
  border: 1px solid #ddd;
  outline: 1300px solid #fff;
  margin: 16px auto;
}

body .markdown-body
{
  padding: 30px;
}

@font-face {
  font-family: octicons-anchor;
  src: url(data:font/woff;charset=utf-8;base64,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) format('woff');
}

.markdown-body {
  -ms-text-size-adjust: 100%;
  -webkit-text-size-adjust: 100%;
  color: #333;
  overflow: hidden;
  font-family: "Helvetica Neue", Helvetica, "Segoe UI", Arial, freesans, sans-serif;
  font-size: 16px;
  line-height: 1.6;
  word-wrap: break-word;
}

.markdown-body a {
  background: transparent;
}

.markdown-body a:active,
.markdown-body a:hover {
  outline: 0;
}

.markdown-body strong {
  font-weight: bold;
}

.markdown-body h1 {
  font-size: 2em;
  margin: 0.67em 0;
}

.markdown-body img {
  border: 0;
}

.markdown-body hr {
  -moz-box-sizing: content-box;
  box-sizing: content-box;
  height: 0;
}

.markdown-body pre {
  overflow: auto;
}

.markdown-body code,
.markdown-body kbd,
.markdown-body pre {
  font-family: monospace, monospace;
  font-size: 1em;
}

.markdown-body input {
  color: inherit;
  font: inherit;
  margin: 0;
}

.markdown-body html input[disabled] {
  cursor: default;
}

.markdown-body input {
  line-height: normal;
}

.markdown-body input[type="checkbox"] {
  -moz-box-sizing: border-box;
  box-sizing: border-box;
  padding: 0;
}

.markdown-body table {
  border-collapse: collapse;
  border-spacing: 0;
}

.markdown-body td,
.markdown-body th {
  padding: 0;
}

.markdown-body * {
  -moz-box-sizing: border-box;
  box-sizing: border-box;
}

.markdown-body input {
  font: 13px/1.4 Helvetica, arial, freesans, clean, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol";
}

.markdown-body a {
  color: #4183c4;
  text-decoration: none;
}

.markdown-body a:hover,
.markdown-body a:focus,
.markdown-body a:active {
  text-decoration: underline;
}

.markdown-body hr {
  height: 0;
  margin: 15px 0;
  overflow: hidden;
  background: transparent;
  border: 0;
  border-bottom: 1px solid #ddd;
}

.markdown-body hr:before {
  display: table;
  content: "";
}

.markdown-body hr:after {
  display: table;
  clear: both;
  content: "";
}

.markdown-body h1,
.markdown-body h2,
.markdown-body h3,
.markdown-body h4,
.markdown-body h5,
.markdown-body h6 {
  margin-top: 15px;
  margin-bottom: 15px;
  line-height: 1.1;
}

.markdown-body h1 {
  font-size: 30px;
}

.markdown-body h2 {
  font-size: 21px;
}

.markdown-body h3 {
  font-size: 16px;
}

.markdown-body h4 {
  font-size: 14px;
}

.markdown-body h5 {
  font-size: 12px;
}

.markdown-body h6 {
  font-size: 11px;
}

.markdown-body blockquote {
  margin: 0;
}

.markdown-body ul,
.markdown-body ol {
  padding: 0;
  margin-top: 0;
  margin-bottom: 0;
}

.markdown-body ol ol,
.markdown-body ul ol {
  list-style-type: lower-roman;
}

.markdown-body ul ul ol,
.markdown-body ul ol ol,
.markdown-body ol ul ol,
.markdown-body ol ol ol {
  list-style-type: lower-alpha;
}

.markdown-body dd {
  margin-left: 0;
}

.markdown-body code {
  font: 12px Consolas, "Liberation Mono", Menlo, Courier, monospace;
}

.markdown-body pre {
  margin-top: 0;
  margin-bottom: 0;
  font: 12px Consolas, "Liberation Mono", Menlo, Courier, monospace;
}

.markdown-body .octicon {
  font: normal normal 16px octicons-anchor;
  line-height: 1;
  display: inline-block;
  text-decoration: none;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.markdown-body .octicon-link:before {
  content: '\f05c';
}

.markdown-body>*:first-child {
  margin-top: 0 !important;
}

.markdown-body>*:last-child {
  margin-bottom: 0 !important;
}

.markdown-body .anchor {
  position: absolute;
  top: 0;
  bottom: 0;
  left: 0;
  display: block;
  padding-right: 6px;
  padding-left: 30px;
  margin-left: -30px;
}

.markdown-body .anchor:focus {
  outline: none;
}

.markdown-body h1,
.markdown-body h2,
.markdown-body h3,
.markdown-body h4,
.markdown-body h5,
.markdown-body h6 {
  position: relative;
  margin-top: 1em;
  margin-bottom: 16px;
  font-weight: bold;
  line-height: 1.4;
}

.markdown-body h1 .octicon-link,
.markdown-body h2 .octicon-link,
.markdown-body h3 .octicon-link,
.markdown-body h4 .octicon-link,
.markdown-body h5 .octicon-link,
.markdown-body h6 .octicon-link {
  display: none;
  color: #000;
  vertical-align: middle;
}

.markdown-body h1:hover .anchor,
.markdown-body h2:hover .anchor,
.markdown-body h3:hover .anchor,
.markdown-body h4:hover .anchor,
.markdown-body h5:hover .anchor,
.markdown-body h6:hover .anchor {
  padding-left: 8px;
  margin-left: -30px;
  line-height: 1;
  text-decoration: none;
}

.markdown-body h1:hover .anchor .octicon-link,
.markdown-body h2:hover .anchor .octicon-link,
.markdown-body h3:hover .anchor .octicon-link,
.markdown-body h4:hover .anchor .octicon-link,
.markdown-body h5:hover .anchor .octicon-link,
.markdown-body h6:hover .anchor .octicon-link {
  display: inline-block;
}

.markdown-body h1 {
  padding-bottom: 0.3em;
  font-size: 2.25em;
  line-height: 1.2;
  border-bottom: 1px solid #eee;
}

.markdown-body h2 {
  padding-bottom: 0.3em;
  font-size: 1.75em;
  line-height: 1.225;
  border-bottom: 1px solid #eee;
}

.markdown-body h3 {
  font-size: 1.5em;
  line-height: 1.43;
}

.markdown-body h4 {
  font-size: 1.25em;
}

.markdown-body h5 {
  font-size: 1em;
}

.markdown-body h6 {
  font-size: 1em;
  color: #777;
}

.markdown-body p,
.markdown-body blockquote,
.markdown-body ul,
.markdown-body ol,
.markdown-body dl,
.markdown-body table,
.markdown-body pre {
  margin-top: 0;
  margin-bottom: 16px;
}

.markdown-body hr {
  height: 4px;
  padding: 0;
  margin: 16px 0;
  background-color: #e7e7e7;
  border: 0 none;
}

.markdown-body ul,
.markdown-body ol {
  padding-left: 2em;
}

.markdown-body ul ul,
.markdown-body ul ol,
.markdown-body ol ol,
.markdown-body ol ul {
  margin-top: 0;
  margin-bottom: 0;
}

.markdown-body li>p {
  margin-top: 16px;
}

.markdown-body dl {
  padding: 0;
}

.markdown-body dl dt {
  padding: 0;
  margin-top: 16px;
  font-size: 1em;
  font-style: italic;
  font-weight: bold;
}

.markdown-body dl dd {
  padding: 0 16px;
  margin-bottom: 16px;
}

.markdown-body blockquote {
  padding: 0 15px;
  color: #777;
  border-left: 4px solid #ddd;
}

.markdown-body blockquote>:first-child {
  margin-top: 0;
}

.markdown-body blockquote>:last-child {
  margin-bottom: 0;
}

.markdown-body table {
  display: block;
  width: 100%;
  overflow: auto;
  word-break: normal;
  word-break: keep-all;
}

.markdown-body table th {
  font-weight: bold;
}

.markdown-body table th,
.markdown-body table td {
  padding: 6px 13px;
  border: 1px solid #ddd;
}

.markdown-body table tr {
  background-color: #fff;
  border-top: 1px solid #ccc;
}

.markdown-body table tr:nth-child(2n) {
  background-color: #f8f8f8;
}

.markdown-body img {
  max-width: 100%;
  -moz-box-sizing: border-box;
  box-sizing: border-box;
}

.markdown-body code {
  padding: 0;
  padding-top: 0.2em;
  padding-bottom: 0.2em;
  margin: 0;
  font-size: 85%;
  background-color: rgba(0,0,0,0.04);
  border-radius: 3px;
}

.markdown-body code:before,
.markdown-body code:after {
  letter-spacing: -0.2em;
  content: "\00a0";
}

.markdown-body pre>code {
  padding: 0;
  margin: 0;
  font-size: 100%;
  word-break: normal;
  white-space: pre;
  background: transparent;
  border: 0;
}

.markdown-body .highlight {
  margin-bottom: 16px;
}

.markdown-body .highlight pre,
.markdown-body pre {
  padding: 16px;
  overflow: auto;
  font-size: 85%;
  line-height: 1.45;
  background-color: #f7f7f7;
  border-radius: 3px;
}

.markdown-body .highlight pre {
  margin-bottom: 0;
  word-break: normal;
}

.markdown-body pre {
  word-wrap: normal;
}

.markdown-body pre code {
  display: inline;
  max-width: initial;
  padding: 0;
  margin: 0;
  overflow: initial;
  line-height: inherit;
  word-wrap: normal;
  background-color: transparent;
  border: 0;
}

.markdown-body pre code:before,
.markdown-body pre code:after {
  content: normal;
}

.markdown-body .highlight {
  background: #fff;
}

.markdown-body .highlight .h {
  color: #333;
  font-style: normal;
  font-weight: normal;
}

.markdown-body .highlight .mf,
.markdown-body .highlight .mh,
.markdown-body .highlight .mi,
.markdown-body .highlight .mo,
.markdown-body .highlight .il,
.markdown-body .highlight .m {
  color: #945277;
}

.markdown-body .highlight .s,
.markdown-body .highlight .sb,
.markdown-body .highlight .sc,
.markdown-body .highlight .sd,
.markdown-body .highlight .s2,
.markdown-body .highlight .se,
.markdown-body .highlight .sh,
.markdown-body .highlight .si,
.markdown-body .highlight .sx,
.markdown-body .highlight .s1 {
  color: #df5000;
}

.markdown-body .highlight .kc,
.markdown-body .highlight .kd,
.markdown-body .highlight .kn,
.markdown-body .highlight .kp,
.markdown-body .highlight .kr,
.markdown-body .highlight .kt,
.markdown-body .highlight .k,
.markdown-body .highlight .o {
  font-weight: bold;
}

.markdown-body .highlight .kt {
  color: #458;
}

.markdown-body .highlight .c,
.markdown-body .highlight .cm,
.markdown-body .highlight .c1 {
  color: #998;
  font-style: italic;
}

.markdown-body .highlight .cp,
.markdown-body .highlight .cs,
.markdown-body .highlight .cp .h {
  color: #999;
  font-weight: bold;
}

.markdown-body .highlight .cs {
  font-style: italic;
}

.markdown-body .highlight .n {
  color: #333;
}

.markdown-body .highlight .na,
.markdown-body .highlight .nv,
.markdown-body .highlight .vc,
.markdown-body .highlight .vg,
.markdown-body .highlight .vi {
  color: #008080;
}

.markdown-body .highlight .nb {
  color: #0086B3;
}

.markdown-body .highlight .nc {
  color: #458;
  font-weight: bold;
}

.markdown-body .highlight .no {
  color: #094e99;
}

.markdown-body .highlight .ni {
  color: #800080;
}

.markdown-body .highlight .ne {
  color: #990000;
  font-weight: bold;
}

.markdown-body .highlight .nf {
  color: #945277;
  font-weight: bold;
}

.markdown-body .highlight .nn {
  color: #555;
}

.markdown-body .highlight .nt {
  color: #000080;
}

.markdown-body .highlight .err {
  color: #a61717;
  background-color: #e3d2d2;
}

.markdown-body .highlight .gd {
  color: #000;
  background-color: #fdd;
}

.markdown-body .highlight .gd .x {
  color: #000;
  background-color: #faa;
}

.markdown-body .highlight .ge {
  font-style: italic;
}

.markdown-body .highlight .gr {
  color: #aa0000;
}

.markdown-body .highlight .gh {
  color: #999;
}

.markdown-body .highlight .gi {
  color: #000;
  background-color: #dfd;
}

.markdown-body .highlight .gi .x {
  color: #000;
  background-color: #afa;
}

.markdown-body .highlight .go {
  color: #888;
}

.markdown-body .highlight .gp {
  color: #555;
}

.markdown-body .highlight .gs {
  font-weight: bold;
}

.markdown-body .highlight .gu {
  color: #800080;
  font-weight: bold;
}

.markdown-body .highlight .gt {
  color: #aa0000;
}

.markdown-body .highlight .ow {
  font-weight: bold;
}

.markdown-body .highlight .w {
  color: #bbb;
}

.markdown-body .highlight .sr {
  color: #017936;
}

.markdown-body .highlight .ss {
  color: #8b467f;
}

.markdown-body .highlight .bp {
  color: #999;
}

.markdown-body .highlight .gc {
  color: #999;
  background-color: #EAF2F5;
}

.markdown-body kbd {
  background-color: #e7e7e7;
  background-image: -webkit-linear-gradient(#fefefe, #e7e7e7);
  background-image: linear-gradient(#fefefe, #e7e7e7);
  background-repeat: repeat-x;
  display: inline-block;
  padding: 3px 5px;
  font: 11px Consolas, "Liberation Mono", Menlo, Courier, monospace;
  line-height: 10px;
  color: #000;
  border: 1px solid #cfcfcf;
  border-radius: 2px;
}

.markdown-body .highlight .pl-coc,
.markdown-body .highlight .pl-entm,
.markdown-body .highlight .pl-eoa,
.markdown-body .highlight .pl-mai .pl-sf,
.markdown-body .highlight .pl-pdv,
.markdown-body .highlight .pl-sc,
.markdown-body .highlight .pl-sr,
.markdown-body .highlight .pl-v,
.markdown-body .highlight .pl-vpf {
  color: #0086b3;
}

.markdown-body .highlight .pl-eoac,
.markdown-body .highlight .pl-mdht,
.markdown-body .highlight .pl-mi1,
.markdown-body .highlight .pl-mri,
.markdown-body .highlight .pl-va,
.markdown-body .highlight .pl-vpu {
  color: #008080;
}

.markdown-body .highlight .pl-c,
.markdown-body .highlight .pl-pdc {
  color: #b4b7b4;
  font-style: italic;
}

.markdown-body .highlight .pl-k,
.markdown-body .highlight .pl-ko,
.markdown-body .highlight .pl-kolp,
.markdown-body .highlight .pl-mc,
.markdown-body .highlight .pl-mr,
.markdown-body .highlight .pl-ms,
.markdown-body .highlight .pl-s,
.markdown-body .highlight .pl-sok,
.markdown-body .highlight .pl-st {
  color: #6e5494;
}

.markdown-body .highlight .pl-ef,
.markdown-body .highlight .pl-enf,
.markdown-body .highlight .pl-enm,
.markdown-body .highlight .pl-entc,
.markdown-body .highlight .pl-eoi,
.markdown-body .highlight .pl-sf,
.markdown-body .highlight .pl-smc {
  color: #d12089;
}

.markdown-body .highlight .pl-ens,
.markdown-body .highlight .pl-eoai,
.markdown-body .highlight .pl-kos,
.markdown-body .highlight .pl-mh .pl-pdh,
.markdown-body .highlight .pl-mp,
.markdown-body .highlight .pl-pde,
.markdown-body .highlight .pl-stp {
  color: #458;
}

.markdown-body .highlight .pl-enti {
  color: #d12089;
  font-weight: bold;
}

.markdown-body .highlight .pl-cce,
.markdown-body .highlight .pl-enc,
.markdown-body .highlight .pl-kou,
.markdown-body .highlight .pl-mq {
  color: #f93;
}

.markdown-body .highlight .pl-mp1 .pl-sf {
  color: #458;
  font-weight: bold;
}

.markdown-body .highlight .pl-cos,
.markdown-body .highlight .pl-ent,
.markdown-body .highlight .pl-md,
.markdown-body .highlight .pl-mdhf,
.markdown-body .highlight .pl-ml,
.markdown-body .highlight .pl-pdc1,
.markdown-body .highlight .pl-pds,
.markdown-body .highlight .pl-s1,
.markdown-body .highlight .pl-scp,
.markdown-body .highlight .pl-sol {
  color: #df5000;
}

.markdown-body .highlight .pl-c1,
.markdown-body .highlight .pl-cn,
.markdown-body .highlight .pl-pse,
.markdown-body .highlight .pl-pse .pl-s2,
.markdown-body .highlight .pl-vi {
  color: #a31515;
}

.markdown-body .highlight .pl-mb,
.markdown-body .highlight .pl-pdb {
  color: #df5000;
  font-weight: bold;
}

.markdown-body .highlight .pl-mi,
.markdown-body .highlight .pl-pdi {
  color: #6e5494;
  font-style: italic;
}

.markdown-body .highlight .pl-ms1 {
  background-color: #f5f5f5;
}

.markdown-body .highlight .pl-mdh,
.markdown-body .highlight .pl-mdi {
  font-weight: bold;
}

.markdown-body .highlight .pl-mdr {
  color: #0086b3;
  font-weight: bold;
}

.markdown-body .highlight .pl-s2 {
  color: #333;
}

.markdown-body .highlight .pl-ii {
  background-color: #df5000;
  color: #fff;
}

.markdown-body .highlight .pl-ib {
  background-color: #f93;
}

.markdown-body .highlight .pl-id {
  background-color: #a31515;
  color: #fff;
}

.markdown-body .highlight .pl-iu {
  background-color: #b4b7b4;
}

.markdown-body .highlight .pl-mo {
  color: #969896;
}

.markdown-body .task-list-item {
  list-style-type: none;
}

.markdown-body .task-list-item+.task-list-item {
  margin-top: 3px;
}

.markdown-body .task-list-item input {
  float: left;
  margin: 0.3em 0 0.25em -1.6em;
  vertical-align: middle;
}</style><title>Bound Services</title></head><body><article class="markdown-body"><p>第二部分bound service</p>

<p>bound service 相当于客户-服务器接口中的服务器。bound service 允许其它组件（除了broadcast receiver）绑定该service，然后进一步操作：发送请求，接收响应，甚至IPC。bound service 只有在其他组件绑定它时才处于存活状态，且会受到绑定它的组件影响。</p>

<p>下面将具体介绍如何创建bound service等相关内容。</p>

<h1>
<a id="user-content-基本知识" class="anchor" href="#%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86" aria-hidden="true"><span class="octicon octicon-link"></span></a>基本知识</h1>

<p>若service允许被别的组件绑定的话，我们必须实现<code>onBind()</code>方法，该方法将返回一个IBinder对象（在启动方式的service中该方法返回null），以便实现和客户端进行交互。</p>

<p>客户端可以通过调用<code>bindService()</code>方法实现绑定，系统会调用服务的<code>onBind(Intent)</code>回调方法，返回一个用于和服务进行交互的 IBinder 对象。之后我们必须实现ServiceConnection接口接收IBinder对象，来监控客户端和服务之间的连接。绑定是异步进行的，<code>bindService()</code>将立即返回，并不会立即向客户端返回IBinder对象。但是我们可以通过ServiceConnection接口中的方法接收IBinder对象，完成通信。</p>

<p>多个客户端可以绑定同一个service，但是只有第一个才会调用<code>onBind()</code>并检索IBinder对象。其它客户端直接接收相同的IBinder对象，而不再调用该方法。</p>

<p>当最后一个客户端解绑service时，系统销毁该service，除非<code>startService()</code>方式启动的service。</p>

<h1>
<a id="user-content-创建bound-service" class="anchor" href="#%E5%88%9B%E5%BB%BAbound-service" aria-hidden="true"><span class="octicon octicon-link"></span></a>创建Bound Service</h1>

<p>当创建bound Serivce时，我们必须提供一个IBinder对象，该对象提供了一个编程接口用于和客户端交互。有下列三种方式定义该接口：</p>

<ul>
<li>
<p>扩展Binder类
若service是应用程序私有的，且和客户端在同一个进程中，可以通过这种方式，一般的bound service都是这种方式。客户端得到Binder实例后可以直接实用该类的public方法，甚至可以service类的public方法。</p>

<p>当我们的service只服务于我们自己的程序时，这种是最好的选择。唯一不使用该方式的原因在于，service被其他应用使用或跨进程。</p>
</li>
<li>
<p>使用Messenger
若接口要跨进程的工作的话，可以通过Messenger。这种方式，service定义了一个Handler来处理不同的Message对象。对于Messenger来说，Handler是基础，它能够和客户端共享Ibinder，运行客户使用Message发送消息到service。另外，客户端可以定义自己的Messenger来处理service回发的消息。</p>

<p>这是最简单的方式实现IPC，因为Messenger把所有请求都放在一个线程中，因此不必担心线程安全问题。</p>
</li>
<li>
<p>使用AIDL
AIDL是Android Interface Definition Language，翻译的话应该是android接口定义语言。AIDL将对象解析为操作系统可识别的原始形态，并将它们跨进程序列化（marshall）以完成IPC（这段翻译的有问题）。使用Messenger也是基于AIDL的，Messenger把所有请求都放在一个线程中，service每次处理一个。然而对于AIDL实现来说。service可以同时处理多个请求。这种情况下，你的服务必须拥有多线程处理能力，并且是以线程安全的方式编写的。</p>

<p>要直接使用AIDL，你必须创建一个<code>.aidl</code>文件，其中定义了编程接口。 Android SDK 工具使用此文件来自动生成一个抽象类，其中实现了接口及对IPC的处理，然后我们就可以在自己的服务中继承该类。</p>
</li>
</ul>

<p>注意：绝大多数应用程序都不应该用AIDL来创建Bound Service，因为这可能需要多线程处理能力并且会让代码变得更为复杂。因此，AIDL对绝大多数应用程序都不适用。</p>

<p>下面详细讲解以上方法（AIDL单独介绍）。</p>

<h2>
<a id="user-content-继承binder类" class="anchor" href="#%E7%BB%A7%E6%89%BFbinder%E7%B1%BB" aria-hidden="true"><span class="octicon octicon-link"></span></a>继承Binder类</h2>

<p>如果只是在应用程序内部使用，并且不需要跨进程，我们可以通过这种方式直接进行交互。这种是最常见的方式。</p>

<p>继承Binder类需要完成如下步骤：</p>

<ol>
<li>在service类中，创建一个Binder对象，该对象可以：</li>
<li>包含public方法，客户端直接可以调用；</li>
<li>返回当前Service对象，该对象的public方法客户端可以调用；</li>
<li>或者返回其它类的对象，该对象能够给客户端提供public方法。</li>
<li>通过在<code>onBind()</code>方法中返回该Binder对象。</li>
<li>在客户端通过ServiceConnection接口中的<code>onServiceConnected()</code>方法接收该Binder对象，然后就可以调用它的相关方法了。</li>
</ol>

<p>注意：service和客户端必须在同一个应用程序的原因在于，客户端可以转换返回的Binder对象，然后调用相关方法；service和客户端必须在一个进程中的原因在于，这种方式不执行任何跨进程的序列化（marshalling）。</p>

<p>注：关于marshalling维基上是这样解释的：In computer science, marshalling or marshaling is the process of transforming the memory representation of an object to a data format suitable for storage or transmission, and it is typically used when data must be moved between different parts of a computer program or from one program to another. Marshalling is similar to serialization and is used to communicate to remote objects with an object, in this case a serialized object. It simplifies complex communication, using custom/complex objects to communicate instead of primitives. The opposite, or reverse, of marshalling is called unmarshalling (or demarshalling, similar to deserialization).</p>

<p>根据官方文档中的示例代码修改代码如下：</p>

<div class="highlight highlight-java"><pre>
<span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">LocalService</span> <span class="pl-k">extends</span> <span class="pl-e">Service</span> {
    <span class="pl-c">// Binder given to clients</span>
    <span class="pl-k">private</span> <span class="pl-k">final</span> <span class="pl-smi">IBinder</span> mBinder <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">LocalBinder</span>();
    <span class="pl-c">// Random number generator</span>
    <span class="pl-k">private</span> <span class="pl-k">final</span> <span class="pl-smi">Random</span> mGenerator <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">Random</span>();

    <span class="pl-c">/**</span>
<span class="pl-c">     * Class used for the client Binder.  Because we know this service always</span>
<span class="pl-c">     * runs in the same process as its clients, we don't need to deal with IPC.</span>
<span class="pl-c">     * 在同一进程中通信，并非IPC</span>
<span class="pl-c">     */</span>
    <span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">LocalBinder</span> <span class="pl-k">extends</span> <span class="pl-e">Binder</span> {
        <span class="pl-c">/**</span>
<span class="pl-c">         * 通过该方法获取LocalService对象</span>
<span class="pl-c">         */</span>
        <span class="pl-smi">LocalService</span> <span class="pl-en">getService</span>() {
            <span class="pl-c">// Return this instance of LocalService so clients can call public methods</span>
            <span class="pl-smi">Log</span><span class="pl-k">.</span>d(<span class="pl-s"><span class="pl-pds">"</span>result<span class="pl-pds">"</span></span>,<span class="pl-s"><span class="pl-pds">"</span>getService executed<span class="pl-pds">"</span></span>);
            <span class="pl-k">return</span> <span class="pl-smi">LocalService</span><span class="pl-k">.</span><span class="pl-v">this</span>;
        }
    }

    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-smi">IBinder</span> <span class="pl-en">onBind</span>(<span class="pl-smi">Intent</span> <span class="pl-v">intent</span>) {
        <span class="pl-smi">Log</span><span class="pl-k">.</span>d(<span class="pl-s"><span class="pl-pds">"</span>result<span class="pl-pds">"</span></span>,<span class="pl-s"><span class="pl-pds">"</span>onBind...<span class="pl-pds">"</span></span>);
        <span class="pl-k">return</span> mBinder;
    }

    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-k">boolean</span> <span class="pl-en">onUnbind</span>(<span class="pl-smi">Intent</span> <span class="pl-v">intent</span>) {
        <span class="pl-smi">Log</span><span class="pl-k">.</span>d(<span class="pl-s"><span class="pl-pds">"</span>result<span class="pl-pds">"</span></span>,<span class="pl-s"><span class="pl-pds">"</span>onUnbind...<span class="pl-pds">"</span></span>);
        <span class="pl-k">return</span> <span class="pl-v">super</span><span class="pl-k">.</span>onUnbind(intent);
    }

    <span class="pl-c">/**</span>
<span class="pl-c">     * method for clients</span>
<span class="pl-c">     * 模拟客户端需要处理的方法</span>
<span class="pl-c">     */</span>
    <span class="pl-k">public</span> <span class="pl-k">int</span> <span class="pl-en">getRandomNumber</span>() {
        <span class="pl-k">return</span> mGenerator<span class="pl-k">.</span>nextInt(<span class="pl-c1">100</span>);
    }
}
</pre></div>

<p>下面是一个绑定LocalService的activity，当点击按钮是回调<code>getRandomNumber()</code>:</p>

<div class="highlight highlight-java"><pre>
<span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">BindingActivity</span> <span class="pl-k">extends</span> <span class="pl-e">Activity</span> {
    <span class="pl-smi">LocalService</span> mService;
    <span class="pl-k">boolean</span> mBound <span class="pl-k">=</span> <span class="pl-c1">false</span>;

    <span class="pl-k">@Override</span>
    <span class="pl-k">protected</span> <span class="pl-k">void</span> <span class="pl-en">onCreate</span>(<span class="pl-smi">Bundle</span> <span class="pl-v">savedInstanceState</span>) {
        <span class="pl-v">super</span><span class="pl-k">.</span>onCreate(savedInstanceState);
        setContentView(<span class="pl-smi">R</span><span class="pl-k">.</span>layout<span class="pl-k">.</span>activity_binding);
    }

    <span class="pl-k">@Override</span>
    <span class="pl-k">protected</span> <span class="pl-k">void</span> <span class="pl-en">onStart</span>() {
        <span class="pl-v">super</span><span class="pl-k">.</span>onStart();
        <span class="pl-c">// Bind to LocalService</span>
        <span class="pl-c">//绑定服务</span>
        <span class="pl-smi">Intent</span> intent <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">Intent</span>(<span class="pl-v">this</span>, <span class="pl-smi">LocalService</span><span class="pl-k">.</span>class);
        bindService(intent, mConnection, <span class="pl-smi">Context</span><span class="pl-c1"><span class="pl-k">.</span>BIND_AUTO_CREATE</span>);
    }

    <span class="pl-k">@Override</span>
    <span class="pl-k">protected</span> <span class="pl-k">void</span> <span class="pl-en">onStop</span>() {
        <span class="pl-v">super</span><span class="pl-k">.</span>onStop();
        <span class="pl-c">// Unbind from the service</span>
        <span class="pl-c">//解除绑定</span>
        <span class="pl-k">if</span> (mBound) {
            unbindService(mConnection);
            mBound <span class="pl-k">=</span> <span class="pl-c1">false</span>;
        }
    }

    <span class="pl-c">/** Called when a button is clicked (the button in the layout file attaches to</span>
<span class="pl-c">     * this method with the android:onClick attribute)</span>
<span class="pl-c">     * 客户端处理服务对象业务方法</span>
<span class="pl-c">     */</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">onButtonClick</span>(<span class="pl-smi">View</span> <span class="pl-v">v</span>) {
        <span class="pl-k">if</span> (mBound) {
            <span class="pl-c">// Call a method from the LocalService.</span>
            <span class="pl-c">// However, if this call were something that might hang, then this request should</span>
            <span class="pl-c">// occur in a separate thread to avoid slowing down the activity performance.</span>
            <span class="pl-c">//若耗时则应在一个新的线程中运行</span>
            <span class="pl-k">int</span> num <span class="pl-k">=</span> mService<span class="pl-k">.</span>getRandomNumber();
            <span class="pl-smi">Toast</span><span class="pl-k">.</span>makeText(<span class="pl-v">this</span>, <span class="pl-s"><span class="pl-pds">"</span>number: <span class="pl-pds">"</span></span> <span class="pl-k">+</span> num, <span class="pl-smi">Toast</span><span class="pl-c1"><span class="pl-k">.</span>LENGTH_SHORT</span>)<span class="pl-k">.</span>show();
        }
    }

    <span class="pl-c">/** Defines callbacks for service binding, passed to bindService()</span>
<span class="pl-c">     * 若onBind(Intent intent)方法不返回对象则不调用该ServiceConnection实例</span>
<span class="pl-c">     */</span>
    <span class="pl-k">private</span> <span class="pl-smi">ServiceConnection</span> mConnection <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">ServiceConnection</span>() {
<span class="pl-c">//执行该方法表示绑定成功，并可以调用服务了。</span>
        <span class="pl-k">@Override</span>
        <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">onServiceConnected</span>(<span class="pl-smi">ComponentName</span> <span class="pl-v">className</span>,
                                       <span class="pl-smi">IBinder</span> <span class="pl-v">service</span>) {
            <span class="pl-c">// We've bound to LocalService, cast the IBinder and get LocalService instance</span>
            <span class="pl-smi">LocalService</span><span class="pl-k">.</span><span class="pl-smi">LocalBinder</span> binder <span class="pl-k">=</span> (<span class="pl-smi">LocalService</span><span class="pl-k">.</span><span class="pl-smi">LocalBinder</span>) service;
            mService <span class="pl-k">=</span> binder<span class="pl-k">.</span>getService();
            <span class="pl-smi">Log</span><span class="pl-k">.</span>d(<span class="pl-s"><span class="pl-pds">"</span>result<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>onServiceConnected...<span class="pl-pds">"</span></span>);
            mBound <span class="pl-k">=</span> <span class="pl-c1">true</span>;
        }

        <span class="pl-k">@Override</span>
        <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">onServiceDisconnected</span>(<span class="pl-smi">ComponentName</span> <span class="pl-v">arg0</span>) {
            <span class="pl-smi">Log</span><span class="pl-k">.</span>d(<span class="pl-s"><span class="pl-pds">"</span>result<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>onServiceDisconnected...<span class="pl-pds">"</span></span>);
            mBound <span class="pl-k">=</span> <span class="pl-c1">false</span>;
        }
    };
}
</pre></div>

<p>可以看到通过上面这种方式可以实现同一进程间客户端（Client）和Bound Service之间的通信。
局限：客户端与Service必须属于同一个进程，不能实现进程间通信（IPC）。否则会出现类似于<code>android.os.BinderProxy cannot be cast to xxx</code>错误。</p>

<p>注：在四大基本组件中，BroadcastReceiver不能作为Bound Service的客户端。因为BroadcastReceiver的生命周期很短，当执行完<code>onReceive()</code>回调时，BroadcastReceiver生命周期完结。而Bound Service又与Client本身的生命周期相关，因此，Android中不允许BroadcastReceiver去<code>bindService()</code>，当有此类需求时，可以考虑通过<code>startService()</code>（四大组件Started Service 都是通过<code>startService()</code>）。</p>

<h2>
<a id="user-content-使用messenger" class="anchor" href="#%E4%BD%BF%E7%94%A8messenger" aria-hidden="true"><span class="octicon octicon-link"></span></a>使用Messenger</h2>

<p>如果需要远程通信，可以使用一个 Messenger 来提供服务的接口。这种技术能无需使用AIDL就能进行进程间通信（IPC）。
Messenger具体使用步骤如下:</p>

<ul>
<li>service中实现一个Handler对象，用于客户端每次调用时处理消息;</li>
<li>通过Handler对象创建一个Messenger对象;</li>
<li>Messenger创建一个IBinder对象，该对象通过<code>onBind()</code>方法返回给客户端；</li>
<li>客户端使用IBinder对象实例化Messenger（这里指的是service的Handler对象），客户端通过该Handler对象将Message对象发送给service；</li>
<li>service通过Handler对象接收每个传递的Message，并在<code>handleMessage()</code>方法中处理；</li>
</ul>

<p>这种方式service没有提供给客户端任何方法，而是客户端传递消息（Message对象）给service。</p>

<p>下面是一个简单的使用Messenger的serivce例子：</p>

<div class="highlight highlight-java"><pre>
<span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">MessengerService</span> <span class="pl-k">extends</span> <span class="pl-e">Service</span> {
    <span class="pl-c">/**</span>
<span class="pl-c">     * Command to the service to display a message</span>
<span class="pl-c">     * 消息标记</span>
<span class="pl-c">     */</span>
    <span class="pl-k">static</span> <span class="pl-k">final</span> <span class="pl-k">int</span> <span class="pl-c1">MSG_SAY_HELLO</span> <span class="pl-k">=</span> <span class="pl-c1">1</span>;

    <span class="pl-c">/**</span>
<span class="pl-c">     * Handler of incoming messages from clients.</span>
<span class="pl-c">     * Handler处理客户端发送过来的消息</span>
<span class="pl-c">     */</span>
    <span class="pl-k">class</span> <span class="pl-en">IncomingHandler</span> <span class="pl-k">extends</span> <span class="pl-e">Handler</span> {
        <span class="pl-k">@Override</span>
        <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">handleMessage</span>(<span class="pl-smi">Message</span> <span class="pl-v">msg</span>) {
            <span class="pl-k">switch</span> (msg<span class="pl-k">.</span>what) {
                <span class="pl-k">case</span> <span class="pl-c1">MSG_SAY_HELLO</span><span class="pl-k">:</span>
                    <span class="pl-smi">Toast</span><span class="pl-k">.</span>makeText(getApplicationContext(), <span class="pl-s"><span class="pl-pds">"</span>hello!<span class="pl-pds">"</span></span>, <span class="pl-smi">Toast</span><span class="pl-c1"><span class="pl-k">.</span>LENGTH_SHORT</span>)<span class="pl-k">.</span>show();
                    <span class="pl-k">break</span>;
                <span class="pl-k">default</span><span class="pl-k">:</span>
                    <span class="pl-v">super</span><span class="pl-k">.</span>handleMessage(msg);
            }
        }
    }

    <span class="pl-c">/**</span>
<span class="pl-c">     * Target we publish for clients to send messages to IncomingHandler.</span>
<span class="pl-c">     * Messenger对象</span>
<span class="pl-c">     */</span>
    <span class="pl-k">final</span> <span class="pl-smi">Messenger</span> mMessenger <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">Messenger</span>(<span class="pl-k">new</span> <span class="pl-smi">IncomingHandler</span>());

    <span class="pl-c">/**</span>
<span class="pl-c">     * When binding to the service, we return an interface to our messenger</span>
<span class="pl-c">     * for sending messages to the service.</span>
<span class="pl-c">     */</span>
    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-smi">IBinder</span> <span class="pl-en">onBind</span>(<span class="pl-smi">Intent</span> <span class="pl-v">intent</span>) {
        <span class="pl-smi">Toast</span><span class="pl-k">.</span>makeText(getApplicationContext(), <span class="pl-s"><span class="pl-pds">"</span>binding<span class="pl-pds">"</span></span>, <span class="pl-smi">Toast</span><span class="pl-c1"><span class="pl-k">.</span>LENGTH_SHORT</span>)<span class="pl-k">.</span>show();
        <span class="pl-k">return</span> mMessenger<span class="pl-k">.</span>getBinder();
    }
}
</pre></div>

<p>所有的客户端都需要根据IBinder对象（service传递过来的）创建一个Messenger实例，然后可以通过<code>send()</code>发送Message对象。例如下面是一个简单的实现绑定service的例子：</p>

<div class="highlight highlight-java"><pre>
<span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">ActivityMessenger</span> <span class="pl-k">extends</span> <span class="pl-e">Activity</span> {
    <span class="pl-c">/**</span>
<span class="pl-c">     * Messenger for communicating with the service.</span>
<span class="pl-c">     * Messenger实例</span>
<span class="pl-c">     */</span>
    <span class="pl-smi">Messenger</span> mService <span class="pl-k">=</span> <span class="pl-c1">null</span>;

    <span class="pl-c">/**</span>
<span class="pl-c">     * Flag indicating whether we have called bind on the service.</span>
<span class="pl-c">     * 标记是否绑定</span>
<span class="pl-c">     */</span>
    <span class="pl-k">boolean</span> mBound;

    <span class="pl-c">/**</span>
<span class="pl-c">     * Class for interacting with the main interface of the service.</span>
<span class="pl-c">     * ServiceConnection接口的实现类</span>
<span class="pl-c">     */</span>
    <span class="pl-k">private</span> <span class="pl-smi">ServiceConnection</span> mConnection <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">ServiceConnection</span>() {
        <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">onServiceConnected</span>(<span class="pl-smi">ComponentName</span> <span class="pl-v">className</span>, <span class="pl-smi">IBinder</span> <span class="pl-v">service</span>) {
            <span class="pl-c">// This is called when the connection with the service has been</span>
            <span class="pl-c">// established, giving us the object we can use to</span>
            <span class="pl-c">// interact with the service.  We are communicating with the</span>
            <span class="pl-c">// service using a Messenger, so here we get a client-side</span>
            <span class="pl-c">// representation of that from the raw IBinder object.</span>
            <span class="pl-c">// 连接成功时调用该方法，IBinder对象是onBinder方法传递过来的</span>
            mService <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">Messenger</span>(service);
            mBound <span class="pl-k">=</span> <span class="pl-c1">true</span>;
        }

        <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">onServiceDisconnected</span>(<span class="pl-smi">ComponentName</span> <span class="pl-v">className</span>) {
            <span class="pl-c">// This is called when the connection with the service has been</span>
            <span class="pl-c">// unexpectedly disconnected -- that is, its process crashed.</span>
            <span class="pl-c">//进程崩溃，连接失败时调用</span>
            mService <span class="pl-k">=</span> <span class="pl-c1">null</span>;
            mBound <span class="pl-k">=</span> <span class="pl-c1">false</span>;
        }
    };

    <span class="pl-c">/**</span>
<span class="pl-c">     * 按钮事件</span>
<span class="pl-c">     */</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">sayHello</span>(<span class="pl-smi">View</span> <span class="pl-v">v</span>) {
        <span class="pl-k">if</span> (<span class="pl-k">!</span>mBound) <span class="pl-k">return</span>;
        <span class="pl-c">// Create and send a message to the service, using a supported 'what' value</span>
        <span class="pl-c">// 创建Message对象</span>
        <span class="pl-smi">Message</span> msg <span class="pl-k">=</span> <span class="pl-smi">Message</span><span class="pl-k">.</span>obtain(<span class="pl-c1">null</span>, <span class="pl-smi">MessengerService</span><span class="pl-c1"><span class="pl-k">.</span>MSG_SAY_HELLO</span>, <span class="pl-c1">0</span>, <span class="pl-c1">0</span>);
        <span class="pl-k">try</span> {
            <span class="pl-c">//发送消息，注意捕获异常</span>
            mService<span class="pl-k">.</span>send(msg);
        } <span class="pl-k">catch</span> (<span class="pl-smi">RemoteException</span> e) {
            e<span class="pl-k">.</span>printStackTrace();
        }
    }

    <span class="pl-k">@Override</span>
    <span class="pl-k">protected</span> <span class="pl-k">void</span> <span class="pl-en">onCreate</span>(<span class="pl-smi">Bundle</span> <span class="pl-v">savedInstanceState</span>) {
        <span class="pl-v">super</span><span class="pl-k">.</span>onCreate(savedInstanceState);
        setContentView(<span class="pl-smi">R</span><span class="pl-k">.</span>layout<span class="pl-k">.</span>main);
    }

    <span class="pl-k">@Override</span>
    <span class="pl-k">protected</span> <span class="pl-k">void</span> <span class="pl-en">onStart</span>() {
        <span class="pl-v">super</span><span class="pl-k">.</span>onStart();
        <span class="pl-c">// Bind to the service</span>
        <span class="pl-c">// 绑定service</span>
        bindService(<span class="pl-k">new</span> <span class="pl-smi">Intent</span>(<span class="pl-v">this</span>, <span class="pl-smi">MessengerService</span><span class="pl-k">.</span>class), mConnection,
            <span class="pl-smi">Context</span><span class="pl-c1"><span class="pl-k">.</span>BIND_AUTO_CREATE</span>);
    }

    <span class="pl-k">@Override</span>
    <span class="pl-k">protected</span> <span class="pl-k">void</span> <span class="pl-en">onStop</span>() {
        <span class="pl-v">super</span><span class="pl-k">.</span>onStop();
        <span class="pl-c">// Unbind from the service</span>
        <span class="pl-c">// 解除绑定</span>
        <span class="pl-k">if</span> (mBound) {
            unbindService(mConnection);
            mBound <span class="pl-k">=</span> <span class="pl-c1">false</span>;
        }
    }
}
</pre></div>

<p>该例子没有展示service如何回应客户端，若是希望回应的话，可以在，，，这里需要写代码验证，，，，，，，，，，，，，，，，
，，，，，，，，，，，，，，，
，，，，，，，，，，，，，，
，，，，，，，，，，，，，，，，
，，，，，，，，，，，，，，
，，，，，，，，，，，，？？
？？？？？？？？？？？？？？
？？？？？？？？？？？？？？</p>

<h1>
<a id="user-content-绑定service" class="anchor" href="#%E7%BB%91%E5%AE%9Aservice" aria-hidden="true"><span class="octicon octicon-link"></span></a>绑定service</h1>

<p>应用程序组件(客户端)能够通过<code>bindService()</code>绑定service。然后系统调用service的<code>onBind()</code>方法，该方法返回一个IBinder对象用于和service进行交互。</p>

<p>绑定是异步的。<code>bindService()</code>会立刻返回，不会返回IBinder对象给客户端。为了接收IBinder对象，客户端必须创建一个ServiceConnection的实例并传递给<code>bindService()</code>。ServiceConnection包括一个回调方法，用于接收IBinder对象。</p>

<p>注意：只有activities，services和content providers能够绑定service，broadcast receiver不能绑定。</p>

<p>为了绑定serivce，我们必须完成一下内容：</p>

<ol>
<li>实现ServiceConnection接口
必须覆盖两个回调方法：
<code>onServiceConnected()</code>
连接成功时通过这个方法接收<code>onBind()</code>传递的IBinder对象。
<code>onServiceDisconnected()</code>
意外断开连接时调用，例如当service崩溃或被杀死时。解绑时不会调用。</li>
<li>调用<code>bindService()</code>，并且传递ServiceConnection实例；</li>
<li>当系统调用<code>onServiceConnected()</code>方法时，可以使用接口中定义的方法和service进行通信；</li>
<li>调用<code>unBindService()</code>解除绑定。
当 客户端被销毁时，它将解绑service，但是我们应该解绑当完成交互时或当service暂停时，这样，service能够在不用时停止。</li>
</ol>

<p>下面给出了一个简单的例子，实现了ServiceConnection接口：</p>

<div class="highlight highlight-java"><pre>
<span class="pl-smi">LocalService</span> mService;
<span class="pl-k">private</span> <span class="pl-smi">ServiceConnection</span> mConnection <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">ServiceConnection</span>() {
    <span class="pl-c">// Called when the connection with the service is established</span>
    <span class="pl-c">//建立连接时被调用</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">onServiceConnected</span>(<span class="pl-smi">ComponentName</span> <span class="pl-v">className</span>, <span class="pl-smi">IBinder</span> <span class="pl-v">service</span>) {
        <span class="pl-c">// Because we have bound to an explicit</span>
        <span class="pl-c">// service that is running in our own process, we can</span>
        <span class="pl-c">// cast its IBinder to a concrete class and directly access it.</span>
        <span class="pl-c">//下面是本地通信（同一个进程中通信）</span>
        <span class="pl-smi">LocalBinder</span> binder <span class="pl-k">=</span> (<span class="pl-smi">LocalBinder</span>) service;
        mService <span class="pl-k">=</span> binder<span class="pl-k">.</span>getService();
        mBound <span class="pl-k">=</span> <span class="pl-c1">true</span>;
    }

    <span class="pl-c">// Called when the connection with the service disconnects unexpectedly</span>
    <span class="pl-c">// 连接失败时调用</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">onServiceDisconnected</span>(<span class="pl-smi">ComponentName</span> <span class="pl-v">className</span>) {
        <span class="pl-smi">Log</span><span class="pl-k">.</span>e(<span class="pl-c1">TAG</span>, <span class="pl-s"><span class="pl-pds">"</span>onServiceDisconnected<span class="pl-pds">"</span></span>);
        mBound <span class="pl-k">=</span> <span class="pl-c1">false</span>;
    }
};
</pre></div>

<p>有了ServiceConnection对象之后，客户端可以通过下列方法绑定service：</p>

<div class="highlight highlight-java"><pre>
<span class="pl-smi">Intent</span> intent <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">Intent</span>(<span class="pl-v">this</span>,<span class="pl-smi">LocalService</span><span class="pl-k">.</span>class);
bindService(intent,mConnection,<span class="pl-smi">Context</span><span class="pl-c1"><span class="pl-k">.</span>BIND_AUTO_CREATE</span>);
</pre></div>

<p>方法参数分别为：</p>

<ul>
<li>显示启动service的intent(隐士的也可以);</li>
<li>ServiceConnection实例;</li>
<li>标记，用于指示绑定的选择，BIND_AUTO_CREATE表示在service没启动时自动自动，还可以有其它值： BIND_DEBUG_UNBIND（调试解绑时的问题）BIND_NOT_FOREGROUND（阻止当前service的进程提高优先级），0 （none）。</li>
</ul>

<h2>
<a id="user-content-其它信息" class="anchor" href="#%E5%85%B6%E5%AE%83%E4%BF%A1%E6%81%AF" aria-hidden="true"><span class="octicon octicon-link"></span></a>其它信息</h2>

<p>关于绑定还有下面一些重要的提示：</p>

<ul>
<li>需要在连接断开时捕获DeadObjectException异常。这是远程方法中抛出的唯一异常。</li>
<li>对象时跨进程统计的参考？？神马意思？？？</li>
<li>
<p>绑定和解绑要在合适的位置进行：</p>

<ul>
<li>若只有当activity可见时才和service进行交互，则须在<code>onStart()</code>方法中绑定，在<code>onStop()</code>中解绑；</li>
<li>若即使activity停止时，我们仍想要activity接收响应，则我们可以在<code>onCreate()</code>中绑定，在<code>onDestroy()</code>中解绑。此时就要多加小心：当前activity需要在整个生命周期中使用service，因此若service在另一个进程中，这种方式增加了该进程被系统杀死的可能性。</li>
</ul>
</li>
</ul>

<p>注意：不要在activity中的<code>onResume()</code>中绑定和在<code>onPause()</code>中解绑，这是因为两个方法会在每次生命周期转换的过程中，应该将这些处理在转换时降到最低。同时，若多个activities中绑定了同一个service，并且在这些acitivities中相互转换的话，service会被频繁地销毁重建（在停止时解绑然后被销毁，该动作发生在另一个activity绑定它之前）。</p>

<h1>
<a id="user-content-管理生命周期" class="anchor" href="#%E7%AE%A1%E7%90%86%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F" aria-hidden="true"><span class="octicon octicon-link"></span></a>管理生命周期</h1>

<p>当service被所有客户端解绑时，系统销毁该service，除非该service先是被started方法的。因此对于存粹绑定的service我们无需管理它的生命周期--系统基于是否绑定客户端来管理。</p>

<p>若你实现了<code>onStartCommand()</code>方法，则此时service被认为是sstarted方式的，因此我们必须管理它的生命周期。在这种情况下，无论是否绑定了客户端，只要调用了stop方法就会service停止。</p>

<p>此外，如果service是started方式，然后被绑定，那么当系统调用<code>onUnbind()</code>方法时，如果我们想要接收<code>onRebind()</code>方法的回调（下一次客户端绑定该service）而不是接收<code>onBind()</code>方法的回调，则我们可以返回true。<code>onRebind()</code>方法没有返回值，但是客户端仍然可以接受IBinder对象。这种生命周期的逻辑如下：</p>

<p>图。。。。。。。。。。。。。。。。。。
。。。。。。。。。。。。。。。。。。。。。。
。。。。。。。。。。。。。。
。。。。。。。。。。。。。。。。。。。。。
。。。。。。。。。。。。。。。。。。。。。。
。。。。。。。。。。。。。。。。。。。。
。。。。。。。。。。。。。。。。。。。。。
。。。。。。。。。。。。。。。。。。
。。。。。。。。。。。。。。。。。。。。。</p>
</article></body></html>