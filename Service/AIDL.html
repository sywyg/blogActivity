<!DOCTYPE html><html><head><meta charset="utf-8"><style>body {
  width: 45em;
  border: 1px solid #ddd;
  outline: 1300px solid #fff;
  margin: 16px auto;
}

body .markdown-body
{
  padding: 30px;
}

@font-face {
  font-family: octicons-anchor;
  src: url(data:font/woff;charset=utf-8;base64,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) format('woff');
}

.markdown-body {
  -ms-text-size-adjust: 100%;
  -webkit-text-size-adjust: 100%;
  color: #333;
  overflow: hidden;
  font-family: "Helvetica Neue", Helvetica, "Segoe UI", Arial, freesans, sans-serif;
  font-size: 16px;
  line-height: 1.6;
  word-wrap: break-word;
}

.markdown-body a {
  background: transparent;
}

.markdown-body a:active,
.markdown-body a:hover {
  outline: 0;
}

.markdown-body strong {
  font-weight: bold;
}

.markdown-body h1 {
  font-size: 2em;
  margin: 0.67em 0;
}

.markdown-body img {
  border: 0;
}

.markdown-body hr {
  -moz-box-sizing: content-box;
  box-sizing: content-box;
  height: 0;
}

.markdown-body pre {
  overflow: auto;
}

.markdown-body code,
.markdown-body kbd,
.markdown-body pre {
  font-family: monospace, monospace;
  font-size: 1em;
}

.markdown-body input {
  color: inherit;
  font: inherit;
  margin: 0;
}

.markdown-body html input[disabled] {
  cursor: default;
}

.markdown-body input {
  line-height: normal;
}

.markdown-body input[type="checkbox"] {
  -moz-box-sizing: border-box;
  box-sizing: border-box;
  padding: 0;
}

.markdown-body table {
  border-collapse: collapse;
  border-spacing: 0;
}

.markdown-body td,
.markdown-body th {
  padding: 0;
}

.markdown-body * {
  -moz-box-sizing: border-box;
  box-sizing: border-box;
}

.markdown-body input {
  font: 13px/1.4 Helvetica, arial, freesans, clean, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol";
}

.markdown-body a {
  color: #4183c4;
  text-decoration: none;
}

.markdown-body a:hover,
.markdown-body a:focus,
.markdown-body a:active {
  text-decoration: underline;
}

.markdown-body hr {
  height: 0;
  margin: 15px 0;
  overflow: hidden;
  background: transparent;
  border: 0;
  border-bottom: 1px solid #ddd;
}

.markdown-body hr:before {
  display: table;
  content: "";
}

.markdown-body hr:after {
  display: table;
  clear: both;
  content: "";
}

.markdown-body h1,
.markdown-body h2,
.markdown-body h3,
.markdown-body h4,
.markdown-body h5,
.markdown-body h6 {
  margin-top: 15px;
  margin-bottom: 15px;
  line-height: 1.1;
}

.markdown-body h1 {
  font-size: 30px;
}

.markdown-body h2 {
  font-size: 21px;
}

.markdown-body h3 {
  font-size: 16px;
}

.markdown-body h4 {
  font-size: 14px;
}

.markdown-body h5 {
  font-size: 12px;
}

.markdown-body h6 {
  font-size: 11px;
}

.markdown-body blockquote {
  margin: 0;
}

.markdown-body ul,
.markdown-body ol {
  padding: 0;
  margin-top: 0;
  margin-bottom: 0;
}

.markdown-body ol ol,
.markdown-body ul ol {
  list-style-type: lower-roman;
}

.markdown-body ul ul ol,
.markdown-body ul ol ol,
.markdown-body ol ul ol,
.markdown-body ol ol ol {
  list-style-type: lower-alpha;
}

.markdown-body dd {
  margin-left: 0;
}

.markdown-body code {
  font: 12px Consolas, "Liberation Mono", Menlo, Courier, monospace;
}

.markdown-body pre {
  margin-top: 0;
  margin-bottom: 0;
  font: 12px Consolas, "Liberation Mono", Menlo, Courier, monospace;
}

.markdown-body .octicon {
  font: normal normal 16px octicons-anchor;
  line-height: 1;
  display: inline-block;
  text-decoration: none;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.markdown-body .octicon-link:before {
  content: '\f05c';
}

.markdown-body>*:first-child {
  margin-top: 0 !important;
}

.markdown-body>*:last-child {
  margin-bottom: 0 !important;
}

.markdown-body .anchor {
  position: absolute;
  top: 0;
  bottom: 0;
  left: 0;
  display: block;
  padding-right: 6px;
  padding-left: 30px;
  margin-left: -30px;
}

.markdown-body .anchor:focus {
  outline: none;
}

.markdown-body h1,
.markdown-body h2,
.markdown-body h3,
.markdown-body h4,
.markdown-body h5,
.markdown-body h6 {
  position: relative;
  margin-top: 1em;
  margin-bottom: 16px;
  font-weight: bold;
  line-height: 1.4;
}

.markdown-body h1 .octicon-link,
.markdown-body h2 .octicon-link,
.markdown-body h3 .octicon-link,
.markdown-body h4 .octicon-link,
.markdown-body h5 .octicon-link,
.markdown-body h6 .octicon-link {
  display: none;
  color: #000;
  vertical-align: middle;
}

.markdown-body h1:hover .anchor,
.markdown-body h2:hover .anchor,
.markdown-body h3:hover .anchor,
.markdown-body h4:hover .anchor,
.markdown-body h5:hover .anchor,
.markdown-body h6:hover .anchor {
  padding-left: 8px;
  margin-left: -30px;
  line-height: 1;
  text-decoration: none;
}

.markdown-body h1:hover .anchor .octicon-link,
.markdown-body h2:hover .anchor .octicon-link,
.markdown-body h3:hover .anchor .octicon-link,
.markdown-body h4:hover .anchor .octicon-link,
.markdown-body h5:hover .anchor .octicon-link,
.markdown-body h6:hover .anchor .octicon-link {
  display: inline-block;
}

.markdown-body h1 {
  padding-bottom: 0.3em;
  font-size: 2.25em;
  line-height: 1.2;
  border-bottom: 1px solid #eee;
}

.markdown-body h2 {
  padding-bottom: 0.3em;
  font-size: 1.75em;
  line-height: 1.225;
  border-bottom: 1px solid #eee;
}

.markdown-body h3 {
  font-size: 1.5em;
  line-height: 1.43;
}

.markdown-body h4 {
  font-size: 1.25em;
}

.markdown-body h5 {
  font-size: 1em;
}

.markdown-body h6 {
  font-size: 1em;
  color: #777;
}

.markdown-body p,
.markdown-body blockquote,
.markdown-body ul,
.markdown-body ol,
.markdown-body dl,
.markdown-body table,
.markdown-body pre {
  margin-top: 0;
  margin-bottom: 16px;
}

.markdown-body hr {
  height: 4px;
  padding: 0;
  margin: 16px 0;
  background-color: #e7e7e7;
  border: 0 none;
}

.markdown-body ul,
.markdown-body ol {
  padding-left: 2em;
}

.markdown-body ul ul,
.markdown-body ul ol,
.markdown-body ol ol,
.markdown-body ol ul {
  margin-top: 0;
  margin-bottom: 0;
}

.markdown-body li>p {
  margin-top: 16px;
}

.markdown-body dl {
  padding: 0;
}

.markdown-body dl dt {
  padding: 0;
  margin-top: 16px;
  font-size: 1em;
  font-style: italic;
  font-weight: bold;
}

.markdown-body dl dd {
  padding: 0 16px;
  margin-bottom: 16px;
}

.markdown-body blockquote {
  padding: 0 15px;
  color: #777;
  border-left: 4px solid #ddd;
}

.markdown-body blockquote>:first-child {
  margin-top: 0;
}

.markdown-body blockquote>:last-child {
  margin-bottom: 0;
}

.markdown-body table {
  display: block;
  width: 100%;
  overflow: auto;
  word-break: normal;
  word-break: keep-all;
}

.markdown-body table th {
  font-weight: bold;
}

.markdown-body table th,
.markdown-body table td {
  padding: 6px 13px;
  border: 1px solid #ddd;
}

.markdown-body table tr {
  background-color: #fff;
  border-top: 1px solid #ccc;
}

.markdown-body table tr:nth-child(2n) {
  background-color: #f8f8f8;
}

.markdown-body img {
  max-width: 100%;
  -moz-box-sizing: border-box;
  box-sizing: border-box;
}

.markdown-body code {
  padding: 0;
  padding-top: 0.2em;
  padding-bottom: 0.2em;
  margin: 0;
  font-size: 85%;
  background-color: rgba(0,0,0,0.04);
  border-radius: 3px;
}

.markdown-body code:before,
.markdown-body code:after {
  letter-spacing: -0.2em;
  content: "\00a0";
}

.markdown-body pre>code {
  padding: 0;
  margin: 0;
  font-size: 100%;
  word-break: normal;
  white-space: pre;
  background: transparent;
  border: 0;
}

.markdown-body .highlight {
  margin-bottom: 16px;
}

.markdown-body .highlight pre,
.markdown-body pre {
  padding: 16px;
  overflow: auto;
  font-size: 85%;
  line-height: 1.45;
  background-color: #f7f7f7;
  border-radius: 3px;
}

.markdown-body .highlight pre {
  margin-bottom: 0;
  word-break: normal;
}

.markdown-body pre {
  word-wrap: normal;
}

.markdown-body pre code {
  display: inline;
  max-width: initial;
  padding: 0;
  margin: 0;
  overflow: initial;
  line-height: inherit;
  word-wrap: normal;
  background-color: transparent;
  border: 0;
}

.markdown-body pre code:before,
.markdown-body pre code:after {
  content: normal;
}

.markdown-body .highlight {
  background: #fff;
}

.markdown-body .highlight .h {
  color: #333;
  font-style: normal;
  font-weight: normal;
}

.markdown-body .highlight .mf,
.markdown-body .highlight .mh,
.markdown-body .highlight .mi,
.markdown-body .highlight .mo,
.markdown-body .highlight .il,
.markdown-body .highlight .m {
  color: #945277;
}

.markdown-body .highlight .s,
.markdown-body .highlight .sb,
.markdown-body .highlight .sc,
.markdown-body .highlight .sd,
.markdown-body .highlight .s2,
.markdown-body .highlight .se,
.markdown-body .highlight .sh,
.markdown-body .highlight .si,
.markdown-body .highlight .sx,
.markdown-body .highlight .s1 {
  color: #df5000;
}

.markdown-body .highlight .kc,
.markdown-body .highlight .kd,
.markdown-body .highlight .kn,
.markdown-body .highlight .kp,
.markdown-body .highlight .kr,
.markdown-body .highlight .kt,
.markdown-body .highlight .k,
.markdown-body .highlight .o {
  font-weight: bold;
}

.markdown-body .highlight .kt {
  color: #458;
}

.markdown-body .highlight .c,
.markdown-body .highlight .cm,
.markdown-body .highlight .c1 {
  color: #998;
  font-style: italic;
}

.markdown-body .highlight .cp,
.markdown-body .highlight .cs,
.markdown-body .highlight .cp .h {
  color: #999;
  font-weight: bold;
}

.markdown-body .highlight .cs {
  font-style: italic;
}

.markdown-body .highlight .n {
  color: #333;
}

.markdown-body .highlight .na,
.markdown-body .highlight .nv,
.markdown-body .highlight .vc,
.markdown-body .highlight .vg,
.markdown-body .highlight .vi {
  color: #008080;
}

.markdown-body .highlight .nb {
  color: #0086B3;
}

.markdown-body .highlight .nc {
  color: #458;
  font-weight: bold;
}

.markdown-body .highlight .no {
  color: #094e99;
}

.markdown-body .highlight .ni {
  color: #800080;
}

.markdown-body .highlight .ne {
  color: #990000;
  font-weight: bold;
}

.markdown-body .highlight .nf {
  color: #945277;
  font-weight: bold;
}

.markdown-body .highlight .nn {
  color: #555;
}

.markdown-body .highlight .nt {
  color: #000080;
}

.markdown-body .highlight .err {
  color: #a61717;
  background-color: #e3d2d2;
}

.markdown-body .highlight .gd {
  color: #000;
  background-color: #fdd;
}

.markdown-body .highlight .gd .x {
  color: #000;
  background-color: #faa;
}

.markdown-body .highlight .ge {
  font-style: italic;
}

.markdown-body .highlight .gr {
  color: #aa0000;
}

.markdown-body .highlight .gh {
  color: #999;
}

.markdown-body .highlight .gi {
  color: #000;
  background-color: #dfd;
}

.markdown-body .highlight .gi .x {
  color: #000;
  background-color: #afa;
}

.markdown-body .highlight .go {
  color: #888;
}

.markdown-body .highlight .gp {
  color: #555;
}

.markdown-body .highlight .gs {
  font-weight: bold;
}

.markdown-body .highlight .gu {
  color: #800080;
  font-weight: bold;
}

.markdown-body .highlight .gt {
  color: #aa0000;
}

.markdown-body .highlight .ow {
  font-weight: bold;
}

.markdown-body .highlight .w {
  color: #bbb;
}

.markdown-body .highlight .sr {
  color: #017936;
}

.markdown-body .highlight .ss {
  color: #8b467f;
}

.markdown-body .highlight .bp {
  color: #999;
}

.markdown-body .highlight .gc {
  color: #999;
  background-color: #EAF2F5;
}

.markdown-body kbd {
  background-color: #e7e7e7;
  background-image: -webkit-linear-gradient(#fefefe, #e7e7e7);
  background-image: linear-gradient(#fefefe, #e7e7e7);
  background-repeat: repeat-x;
  display: inline-block;
  padding: 3px 5px;
  font: 11px Consolas, "Liberation Mono", Menlo, Courier, monospace;
  line-height: 10px;
  color: #000;
  border: 1px solid #cfcfcf;
  border-radius: 2px;
}

.markdown-body .highlight .pl-coc,
.markdown-body .highlight .pl-entm,
.markdown-body .highlight .pl-eoa,
.markdown-body .highlight .pl-mai .pl-sf,
.markdown-body .highlight .pl-pdv,
.markdown-body .highlight .pl-sc,
.markdown-body .highlight .pl-sr,
.markdown-body .highlight .pl-v,
.markdown-body .highlight .pl-vpf {
  color: #0086b3;
}

.markdown-body .highlight .pl-eoac,
.markdown-body .highlight .pl-mdht,
.markdown-body .highlight .pl-mi1,
.markdown-body .highlight .pl-mri,
.markdown-body .highlight .pl-va,
.markdown-body .highlight .pl-vpu {
  color: #008080;
}

.markdown-body .highlight .pl-c,
.markdown-body .highlight .pl-pdc {
  color: #b4b7b4;
  font-style: italic;
}

.markdown-body .highlight .pl-k,
.markdown-body .highlight .pl-ko,
.markdown-body .highlight .pl-kolp,
.markdown-body .highlight .pl-mc,
.markdown-body .highlight .pl-mr,
.markdown-body .highlight .pl-ms,
.markdown-body .highlight .pl-s,
.markdown-body .highlight .pl-sok,
.markdown-body .highlight .pl-st {
  color: #6e5494;
}

.markdown-body .highlight .pl-ef,
.markdown-body .highlight .pl-enf,
.markdown-body .highlight .pl-enm,
.markdown-body .highlight .pl-entc,
.markdown-body .highlight .pl-eoi,
.markdown-body .highlight .pl-sf,
.markdown-body .highlight .pl-smc {
  color: #d12089;
}

.markdown-body .highlight .pl-ens,
.markdown-body .highlight .pl-eoai,
.markdown-body .highlight .pl-kos,
.markdown-body .highlight .pl-mh .pl-pdh,
.markdown-body .highlight .pl-mp,
.markdown-body .highlight .pl-pde,
.markdown-body .highlight .pl-stp {
  color: #458;
}

.markdown-body .highlight .pl-enti {
  color: #d12089;
  font-weight: bold;
}

.markdown-body .highlight .pl-cce,
.markdown-body .highlight .pl-enc,
.markdown-body .highlight .pl-kou,
.markdown-body .highlight .pl-mq {
  color: #f93;
}

.markdown-body .highlight .pl-mp1 .pl-sf {
  color: #458;
  font-weight: bold;
}

.markdown-body .highlight .pl-cos,
.markdown-body .highlight .pl-ent,
.markdown-body .highlight .pl-md,
.markdown-body .highlight .pl-mdhf,
.markdown-body .highlight .pl-ml,
.markdown-body .highlight .pl-pdc1,
.markdown-body .highlight .pl-pds,
.markdown-body .highlight .pl-s1,
.markdown-body .highlight .pl-scp,
.markdown-body .highlight .pl-sol {
  color: #df5000;
}

.markdown-body .highlight .pl-c1,
.markdown-body .highlight .pl-cn,
.markdown-body .highlight .pl-pse,
.markdown-body .highlight .pl-pse .pl-s2,
.markdown-body .highlight .pl-vi {
  color: #a31515;
}

.markdown-body .highlight .pl-mb,
.markdown-body .highlight .pl-pdb {
  color: #df5000;
  font-weight: bold;
}

.markdown-body .highlight .pl-mi,
.markdown-body .highlight .pl-pdi {
  color: #6e5494;
  font-style: italic;
}

.markdown-body .highlight .pl-ms1 {
  background-color: #f5f5f5;
}

.markdown-body .highlight .pl-mdh,
.markdown-body .highlight .pl-mdi {
  font-weight: bold;
}

.markdown-body .highlight .pl-mdr {
  color: #0086b3;
  font-weight: bold;
}

.markdown-body .highlight .pl-s2 {
  color: #333;
}

.markdown-body .highlight .pl-ii {
  background-color: #df5000;
  color: #fff;
}

.markdown-body .highlight .pl-ib {
  background-color: #f93;
}

.markdown-body .highlight .pl-id {
  background-color: #a31515;
  color: #fff;
}

.markdown-body .highlight .pl-iu {
  background-color: #b4b7b4;
}

.markdown-body .highlight .pl-mo {
  color: #969896;
}

.markdown-body .task-list-item {
  list-style-type: none;
}

.markdown-body .task-list-item+.task-list-item {
  margin-top: 3px;
}

.markdown-body .task-list-item input {
  float: left;
  margin: 0.3em 0 0.25em -1.6em;
  vertical-align: middle;
}</style><title>AIDL</title></head><body><article class="markdown-body"><p>解读Android之Service(3)AIDL</p>

<p>Android Interface Definition Language(AIDL)</p>

<p>AIDL能够让我们定义自己的编程接口，该接口可以使得客户端和service之间进行跨进程通信(interprocess communication,IPC)。通常，在android中无法直接跨进程通信。因此，需要把传递的对象分解成系统可以识别的原始状态（数据），并将它们跨进程序列化marshalling。由于marshalling过程繁琐，因此android通过AIDL处理。</p>

<p>注意：只有当我们允许不同应用程序的客户端获取service来进行IPC，并且在service中需要处理多线程时，AIDL才是必须的。绝大多数应用程序都不应该用AIDL来创建Bound Service，因为这可能需要多线程处理能力并且会让代码变得更为复杂。因此，AIDL对绝大多数应用程序都不适用。如果只是在应用程序内部使用，并且不需要跨进程，我们可以通过继承Binder类直接进行交互，这种是最常见的方式。若跨进程IPC且不需要处理多线程问题可以通过使用Messenger方法，因为Messenger把所有请求都放在一个线程中，因此不必担心线程安全问题。</p>

<p>（下面的理解上还有些问题）在开始设计AIDL接口之前，需要注意的是调用AIDL接口是直接的调用方法，我们不应该假设调用方法发生在子线程。从本地进程和远程进程中的线程调用是不同的：</p>

<ul>
<li>在本地进程中调用。若在主线程中调用，则AIDL接口会在主线程中执行。若是另外的子线程，则该线程执行service中的代码。因此 若只有本地线程获取service，我们能够完全控制。这种情况不应该使用AIDL，而是继承Binder实现。</li>
<li>若是远程进程调用，则AIDL的实现必须要保证完全地线程安全。这是因为若是支持远程调用的话可能需要同时处理多个调用（并发处理）。</li>
<li>单向改变远程调用行为。当使用这种方式时，远程调用不会阻塞；它简单的发送数据，并立刻返回。最终，接口实现接收向常规的通过Binder线程池调用一样处理远程调用。若单向用在本地调用，则不会影响并且调用仍是异步的。</li>
</ul>

<p><em>上述内容理解有的问题，须再查阅资料并验证</em>，同时请各位不吝赐教。</p>

<h1>
<a id="user-content-定义aidl接口" class="anchor" href="#%E5%AE%9A%E4%B9%89aidl%E6%8E%A5%E5%8F%A3" aria-hidden="true"><span class="octicon octicon-link"></span></a>定义AIDL接口</h1>

<p>AIDL接口必须定义在<code>.aidl</code>文件中（命名满足java语法），并同时保存在service所在的应用程序和其它绑定该service的应用程序（需要通过AIDL进行IPC的service）中，保存位置为源代码中<code>src/</code>目录下。</p>

<p>当我们新建一个<code>.aidl</code>文件时，android SDK工具就会根据该文件自动生成一个IBinder接口，并且保存在<code>gen/</code>目录下。service必须实现IBinder接口，客户端才能绑定service并调用方法获得该对象进行IPC。</p>

<p>上面的目录是在eclipse中的，在android studio中则在：</p>

<p>为了能够创建使用AIDL的service，必须要实现以下步骤：</p>

<ol>
<li>创建<code>.aidl</code>文件
该文件定义了带有方法声明的编程接口</li>
<li>实现接口
android SDK工具使用java生成一个接口，依据是根据<code>.aidl</code>文件。这个接口中有一个内部抽象类Stub，该类继承了Binder类，并且实现了AIDL接口中的方法，我们必须继承Stub类和实现其方法。</li>
<li>将接口暴露给客户端
实现Service类，覆盖<code>onBind()</code>方法，并且返回Stub的实现。</li>
</ol>

<p>注意：在我们第一次发布之后的改变AIDL接口都要保证对原来的版本的兼容性，避免其它应用无法访问我们的service（其它客户端可能拷贝的还是原来的接口版本）。</p>

<p>下面详细介绍以上几步：</p>

<h2>
<a id="user-content-1-创建aidl文件" class="anchor" href="#1-%E5%88%9B%E5%BB%BAaidl%E6%96%87%E4%BB%B6" aria-hidden="true"><span class="octicon octicon-link"></span></a>1. 创建<code>.aidl</code>文件</h2>

<p>AIDL需要满足一些简单的语法：能够使我们声明一个接口，该接口可以包含一个或多个方法，且能够带有参数和返回值。参数和返回值可以是任何类型的甚至是其它AIDL生成的接口。</p>

<p>每个<code>.aidl</code>文件必须定义一个接口，并且只需要接口声明和方法声明。</p>

<p>默认情况下，AIDL支持以下数据类型：</p>

<ul>
<li>java中八大基本数据类型</li>
<li>String</li>
<li>CharSequence</li>
<li>List
当然，List中的类型也需要是AIDL支持的类型。通常使用List声明变量，而具体的类型（例如ArrayList）在定义时确定。</li>
<li>Map
和List用法一样。</li>
</ul>

<p>若是使用上述以外的类型（例如自定义类）必须导入相关声明，即使在同一个包中定义的。</p>

<p>在定义AIDL接口时，需要注意以下几点：</p>

<ul>
<li>方法可以带有0个或多个参数，可以选择有无返回值。</li>
<li>所有的非基本数据类型都需要指定一个方向来标记数据的流向（进，出，进出同时）。基本数据类型默认是进，且不能改变。我们有必要限制数据方向（真正需要的方向），原因在于marshalling参数的代价消耗大。</li>
<li>文件中的所有代码注释都被包含在生成的IBinder接口中，除非是import和package之前注释的。</li>
<li>只支持方法，不支持静态成员变量。且方法不能有修饰符。</li>
<li>需要手动输入包名（android studio不需要手动）</li>
</ul>

<p>下面有一个例子：</p>

<div class="highlight highlight-java"><pre>
<span class="pl-k">package</span> <span class="pl-smi">com.sywyg.servicetest</span>;

<span class="pl-k">import</span> <span class="pl-smi">com.sywyg.servicetest.Man</span>;
<span class="pl-c">// Declare any non-default types here with import statements</span>
<span class="pl-c">// 需要导入自定义类型的位置</span>
<span class="pl-k">interface</span> <span class="pl-en">IRemoteService</span>{
   <span class="pl-c">/** Request the process ID of this service, to do evil things with it. */</span>
    <span class="pl-k">int</span> <span class="pl-en">getPid</span>();

    <span class="pl-c">/** Demonstrates some basic types that you can use as parameters</span>
<span class="pl-c">     * and return values in AIDL.</span>
<span class="pl-c">     */</span>
    <span class="pl-k">void</span> <span class="pl-en">basicTypes</span>(<span class="pl-k">int</span> <span class="pl-v">anInt</span>, <span class="pl-k">long</span> <span class="pl-v">aLong</span>, <span class="pl-k">boolean</span> <span class="pl-v">aBoolean</span>, <span class="pl-k">float</span> <span class="pl-v">aFloat</span>,
              <span class="pl-k">double</span> <span class="pl-v">aDouble</span>, <span class="pl-smi">String</span> <span class="pl-v">aString</span>);
     <span class="pl-c">// Man getMan();</span>
}

</pre></div>

<p>然后系统就会自动生成一个IRemoteService.java（对应IRemoteService.aidl）文件。
有的编译器是立刻生成，有的则在编译应用程序时生成，这点注意。</p>

<h2>
<a id="user-content-2-实现接口" class="anchor" href="#2-%E5%AE%9E%E7%8E%B0%E6%8E%A5%E5%8F%A3" aria-hidden="true"><span class="octicon octicon-link"></span></a>2. 实现接口</h2>

<p>自动生成文件包含一个子类Stub，是父类接口的一个抽象实现，实现了<code>.aidl</code>文件中的所有方法。Stub同时定义了一些其他有用的方法，尤其是<code>asInterface()</code>方法，该方法接收一个IBinder对象，返回Stub接口的实现。</p>

<p><em>关于Stub后续有详细的介绍，这里只介绍一下如何使用。</em></p>

<p>下面用一个匿名类实现简单的接口实例：</p>

<div class="highlight highlight-java"><pre>    <span class="pl-c">/**</span>
<span class="pl-c">     * 定义一个匿名内部类实现aidl接口，需要继承IRemoteService.Stub类</span>
<span class="pl-c">     * 在.aidl文件中声明的方法需要在这里实现具体功能</span>
<span class="pl-c">     */</span>
    <span class="pl-k">private</span> <span class="pl-k">final</span> <span class="pl-smi">IRemoteService</span><span class="pl-k">.</span><span class="pl-smi">Stub</span> mBinder <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">IRemoteService</span>.<span class="pl-smi">Stub</span>() {
        <span class="pl-k">public</span> <span class="pl-k">int</span> <span class="pl-en">getPid</span>(){
            <span class="pl-smi">Log</span><span class="pl-k">.</span>d(<span class="pl-c1">TAG</span>,<span class="pl-s"><span class="pl-pds">"</span>getPid is executed ...<span class="pl-pds">"</span></span>);
            <span class="pl-k">return</span> <span class="pl-smi">android.os<span class="pl-k">.</span>Process</span><span class="pl-k">.</span>myPid();
        }
        <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">basicTypes</span>(<span class="pl-k">int</span> <span class="pl-v">anInt</span>, <span class="pl-k">long</span> <span class="pl-v">aLong</span>, <span class="pl-k">boolean</span> <span class="pl-v">aBoolean</span>,
                                   <span class="pl-k">float</span> <span class="pl-v">aFloat</span>, <span class="pl-k">double</span> <span class="pl-v">aDouble</span>, <span class="pl-smi">String</span> <span class="pl-v">aString</span>) {
            <span class="pl-smi">Log</span><span class="pl-k">.</span>d(<span class="pl-c1">TAG</span>,<span class="pl-s"><span class="pl-pds">"</span>basicTypes is executed ...<span class="pl-pds">"</span></span>);
        }
    };
</pre></div>

<p>Stub实现了Binder类（定义了远程过程调用协议Remote Procedure Call Protocol RPC），因此mBinder可以传输给客户端。</p>

<p>在实现AIDL时需要注意一下几点：</p>

<ul>
<li>调用不能保证在主线程中执行，我们应该考虑多线程问题，并保证service是线程安全的。</li>
<li>默认情况，RPC调用是异步的。若service需要长时间的操作要保证调用不能发生在主线程中，因为这个可能出现应用程序无法响应问题Application Not Responding ANR。因此我们应该保证调用发生在另外的子线程中。</li>
<li>不会给调用者抛出异常。</li>
</ul>

<h2>
<a id="user-content-3-将接口暴露给客户端" class="anchor" href="#3-%E5%B0%86%E6%8E%A5%E5%8F%A3%E6%9A%B4%E9%9C%B2%E7%BB%99%E5%AE%A2%E6%88%B7%E7%AB%AF" aria-hidden="true"><span class="octicon octicon-link"></span></a>3. 将接口暴露给客户端</h2>

<p>为service实现了AIDL接口，我们应该把接口暴露给客户端，使得他们能够绑定它。下面给出完整的代码，说明如何实现：</p>

<div class="highlight highlight-java"><pre>
<span class="pl-c">/**</span>
<span class="pl-c"> * 通过AIDL实现IPC</span>
<span class="pl-c"> * @author sywyg</span>
<span class="pl-c"> * @since 2015.7.16</span>
<span class="pl-c"> */</span>
<span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">AIDLService</span> <span class="pl-k">extends</span> <span class="pl-e">Service</span> {
    <span class="pl-k">private</span> <span class="pl-k">final</span> <span class="pl-smi">String</span> <span class="pl-c1">TAG</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>result<span class="pl-pds">"</span></span>;
    <span class="pl-k">public</span> <span class="pl-en">AIDLService</span>() {
    }

    <span class="pl-c">/**</span>
<span class="pl-c">     * 定义一个匿名内部类实现aidl接口，需要继承IRemoteService.Stub类</span>
<span class="pl-c">     * 在.aidl文件中声明的方法需要在这里实现具体功能</span>
<span class="pl-c">     */</span>
    <span class="pl-k">private</span> <span class="pl-k">final</span> <span class="pl-smi">IRemoteService</span><span class="pl-k">.</span><span class="pl-smi">Stub</span> mBinder <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">IRemoteService</span>.<span class="pl-smi">Stub</span>() {
        <span class="pl-k">public</span> <span class="pl-k">int</span> <span class="pl-en">getPid</span>(){
            <span class="pl-smi">Log</span><span class="pl-k">.</span>d(<span class="pl-c1">TAG</span>,<span class="pl-s"><span class="pl-pds">"</span>getPid is executed ...<span class="pl-pds">"</span></span>);
            <span class="pl-k">return</span> <span class="pl-smi">android.os<span class="pl-k">.</span>Process</span><span class="pl-k">.</span>myPid();
        }
        <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">basicTypes</span>(<span class="pl-k">int</span> <span class="pl-v">anInt</span>, <span class="pl-k">long</span> <span class="pl-v">aLong</span>, <span class="pl-k">boolean</span> <span class="pl-v">aBoolean</span>,
                                   <span class="pl-k">float</span> <span class="pl-v">aFloat</span>, <span class="pl-k">double</span> <span class="pl-v">aDouble</span>, <span class="pl-smi">String</span> <span class="pl-v">aString</span>) {
            <span class="pl-smi">Log</span><span class="pl-k">.</span>d(<span class="pl-c1">TAG</span>,<span class="pl-s"><span class="pl-pds">"</span>basicTypes is executed ...<span class="pl-pds">"</span></span>);
        }
    };

    <span class="pl-k">@Override</span>
    <span class="pl-k">public</span> <span class="pl-smi">IBinder</span> <span class="pl-en">onBind</span>(<span class="pl-smi">Intent</span> <span class="pl-v">intent</span>) {

        <span class="pl-k">return</span> mBinder;
    }
}
</pre></div>

<p>那么，当客户端调用<code>bindService()</code>连接service时，客户端回调<code>onServiceConnected()</code>方法接收mBinder实例(service的<code>onBinder()</code>方法返回的)。</p>

<p>客户端必须也能够获得该接口类，因此当客户端和service在不同的应用程序时，客户端应用程序必须复制一份<code>.aidl</code>文件，这样才能获得AIDL中的方法。</p>

<p>当客户在<code>onServiceConnected()</code>方法中接收IBinder对象时，必须通过调用<code>YourServiceInterface.Stub.asInterface(service)</code>转换为YourServiceInterface类型。如下：</p>

<div class="highlight highlight-java"><pre>
<span class="pl-smi">IRemoteService</span> mIRemoteService;
  <span class="pl-k">private</span> <span class="pl-smi">ServiceConnection</span> mConnection <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">ServiceConnection</span>() {
        <span class="pl-k">@Override</span>
        <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">onServiceConnected</span>(<span class="pl-smi">ComponentName</span> <span class="pl-v">name</span>, <span class="pl-smi">IBinder</span> <span class="pl-v">service</span>) {
            <span class="pl-smi">Log</span><span class="pl-k">.</span>d(<span class="pl-c1">TAG</span>,<span class="pl-s"><span class="pl-pds">"</span>绑定成功<span class="pl-pds">"</span></span>);
            <span class="pl-c">// Following the example above for an AIDL interface,</span>
            <span class="pl-c">// this gets an instance of the IRemoteService, which we can use to call on the service</span>
            <span class="pl-c">// 还是接着上面的例子，通过这种方式获得IRemoteService的一个实例，</span>
            <span class="pl-c">// 这样，我们可以在客户端进行处理了。</span>
            mIRemoteService <span class="pl-k">=</span> <span class="pl-smi">IRemoteService</span><span class="pl-k">.</span><span class="pl-smi">Stub</span><span class="pl-k">.</span>asInterface(service);

            mBound <span class="pl-k">=</span> <span class="pl-c1">true</span>;
        }

        <span class="pl-k">@Override</span>
        <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">onServiceDisconnected</span>(<span class="pl-smi">ComponentName</span> <span class="pl-v">name</span>) {
            mBound <span class="pl-k">=</span> <span class="pl-c1">false</span>;
        }
    };
</pre></div>

<h1>
<a id="user-content-通过ipc传递对象" class="anchor" href="#%E9%80%9A%E8%BF%87ipc%E4%BC%A0%E9%80%92%E5%AF%B9%E8%B1%A1" aria-hidden="true"><span class="octicon octicon-link"></span></a>通过IPC传递对象</h1>

<p>我们可以实现通过IPC把对象从一个进程传递到另一个进程中。但是，我们必须要确保在另一个进程中可以获得该对象（即需要该类的代码），并且该类需要支持Parcelable接口。必须要支持Parcelable，这样系统才能将对象分解为基本数据类型（能够跨进程marshalled）。</p>

<p>注意：Parcelable是一个接口，实现该接口的类实例能够保存在Parcel中并从中恢复。该类中必须有一个名叫CREATOR的静态成员变量，该成员是Parcelable.Creator的一个实现实例。</p>

<p>为了创建支持Parcelable协议的类，必须完成以下几点：</p>

<ol>
<li>该类必须实现Parcelable接口；</li>
<li>实现<code>writeToParcel()和</code>方法，记录当前对象的状态（成员变量等），并用Parcel保存。还要实现<code>describeContents()</code>，一般返回0；</li>
<li>添加静态成员变量CREAROR，该成员是Parcelable.Creator的一个实现实例；</li>
<li>最后创建一个<code>.aidl</code>文件声明该parcelable类（例如下面的Rect.aidl文件）。若你正在进行自定义生成过程，不要添加<code>.aidl</code>文件，这是因为，它类似C语言的头文件，不会进行编译的。？？？茫然</li>
</ol>

<p>AIDL通过上述办法产生marshall和unmarshall对象。</p>

<p>下面是一个实现Parcelable接口的类Rect，首先要有Rect.aidl文件：</p>

<pre><code>
package android.graphics;

// Declare Rect so AIDL can find it and knows that it implements
// the parcelable protocol.
// 声明Rect，AIDL好找到并确认它实现了parcelable协议
parcelable Rect;

</code></pre>

<p>下面是Rect类：</p>

<div class="highlight highlight-java"><pre>
<span class="pl-k">import</span> <span class="pl-smi">android.os.Parcel</span>;
<span class="pl-k">import</span> <span class="pl-smi">android.os.Parcelable</span>;

<span class="pl-k">public</span> <span class="pl-k">final</span> <span class="pl-k">class</span> <span class="pl-en">Rect</span> <span class="pl-k">implements</span> <span class="pl-e">Parcelable</span> {
    <span class="pl-k">public</span> <span class="pl-k">int</span> left;
    <span class="pl-k">public</span> <span class="pl-k">int</span> top;
    <span class="pl-k">public</span> <span class="pl-k">int</span> right;
    <span class="pl-k">public</span> <span class="pl-k">int</span> bottom;

    <span class="pl-k">public</span> <span class="pl-k">static</span> <span class="pl-k">final</span> <span class="pl-smi">Parcelable</span><span class="pl-k">.</span><span class="pl-k">Creator&lt;<span class="pl-smi">Rect</span>&gt;</span> <span class="pl-c1">CREATOR</span> <span class="pl-k">=</span> <span class="pl-k">new</span>
<span class="pl-smi">Parcelable</span>.<span class="pl-k">Creator&lt;<span class="pl-smi">Rect</span>&gt;</span>() {
        <span class="pl-k">public</span> <span class="pl-smi">Rect</span> <span class="pl-en">createFromParcel</span>(<span class="pl-smi">Parcel</span> <span class="pl-v">in</span>) {
            <span class="pl-k">return</span> <span class="pl-k">new</span> <span class="pl-smi">Rect</span>(in);
        }

        <span class="pl-k">public</span> <span class="pl-k">Rect</span>[] <span class="pl-en">newArray</span>(<span class="pl-k">int</span> <span class="pl-v">size</span>) {
            <span class="pl-k">return</span> <span class="pl-k">new</span> <span class="pl-smi">Rect</span>[size];
        }
    };

    <span class="pl-k">public</span> <span class="pl-en">Rect</span>() {
    }

    <span class="pl-k">private</span> <span class="pl-en">Rect</span>(<span class="pl-smi">Parcel</span> <span class="pl-v">in</span>) {
        readFromParcel(in);
    }

    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">writeToParcel</span>(<span class="pl-smi">Parcel</span> <span class="pl-v">out</span>) {
        out<span class="pl-k">.</span>writeInt(left);
        out<span class="pl-k">.</span>writeInt(top);
        out<span class="pl-k">.</span>writeInt(right);
        out<span class="pl-k">.</span>writeInt(bottom);
    }

    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">readFromParcel</span>(<span class="pl-smi">Parcel</span> <span class="pl-v">in</span>) {
        left <span class="pl-k">=</span> in<span class="pl-k">.</span>readInt();
        top <span class="pl-k">=</span> in<span class="pl-k">.</span>readInt();
        right <span class="pl-k">=</span> in<span class="pl-k">.</span>readInt();
        bottom <span class="pl-k">=</span> in<span class="pl-k">.</span>readInt();
    }
}
</pre></div>

<p>Parcel同样可以写其它类型的数据。</p>

<p>警告：不要忘记从另一个进程中获取数据时的安全问题。上面的例子，Rect获取四个数，但是这取决于你获得多少数据（读写顺序要一致）。</p>

<h1>
<a id="user-content-调用ipc方法" class="anchor" href="#%E8%B0%83%E7%94%A8ipc%E6%96%B9%E6%B3%95" aria-hidden="true"><span class="octicon octicon-link"></span></a>调用IPC方法</h1>

<p>客户端必须完成以下步骤才能实现调用远程接口：</p>

<ol>
<li>在项目中包含<code>.aidl</code>文件。</li>
<li>声明一个IBinder对象实例（基于AIDL产生的）。</li>
<li>实现ServiceConnection。</li>
<li>调用<code>Context.bindService()</code>，并传递ServiceConnection的实现。</li>
<li>在<code>onServiceConnected()</code>实现中，我们可以接受IBinder的一个实例（名为service)。调用<code>asInterface()</code>转换成接口实例。</li>
<li>调用在接口中定义的方法。必须要捕获DeadObjectionException异常（当连接断开时），这是调用远程方法的唯一异常。</li>
<li>调用<code>Context.unBindService()</code>解除连接。</li>
</ol>

<p>调用IPC service注意事项：</p>

<ul>
<li>对象是跨进程计数的引用类型，上一章讲的一样，可能会造成内存泄漏。</li>
<li>能够发送匿名对象作为方法参数。</li>
</ul>
</article></body></html>